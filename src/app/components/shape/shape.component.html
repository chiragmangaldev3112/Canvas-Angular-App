<div 
  class="shape-container"
  [style.left.px]="shape.x"
  [style.top.px]="shape.y"
  [style.zIndex]="shape.zIndex">
  
  <!-- Debug info for shape -->
  <div [hidden]="true" style="position: absolute; top: 0; left: 0; background: rgba(0,0,0,0.7); color: white; padding: 4px; font-size: 10px; z-index: 1000;" *ngIf="shape">
    ID: {{shape.id}} | {{shape.type}} | ({{shape.x}}, {{shape.y}})
  </div>

  <!-- OUTER SHAPE CONTAINER (ensure relative positioning) -->
  <div #shapeElement class="shape-root" style="position: relative;">
    <!-- Shape element -->
    <div 
      class="shape"
      [class.circle]="shape.type === 'circle'"
      [class.square]="shape.type === 'square'"
      [class.selected]="isSelected"
      [class.is-dragging]="isDragging"
      [style.width.px]="shape.width"
      [style.height.px]="shape.height"
      [style.background]="shapeColor"
      [style.border]="'2px dashed ' + (shapeColor === '#FFFFFF' ? 'red' : shapeColor)"
      (mousedown)="onMouseDown($event)">
    </div>

    <!-- Color Picker -->
    <div class="color-picker-wrapper"  [hidden]="true">
      <button class="color-picker-toggle" (click)="toggleColorPicker($event)" [style.background]="shapeColor" title="Pick color">
        ðŸŽ¨
      </button>
      <div class="color-picker-palette" *ngIf="colorPickerOpen">
        <div class="color-swatch" *ngFor="let color of colorOptions"
             [style.background]="color"
             [class.selected]="color === shapeColor"
             (click)="setShapeColor(color)"
             [title]="color">
        </div>
      </div>
    </div>
    
    <!-- Text container -->
    <div 
      #shapeTextContainer
      class="shape-text-container" 
      *ngIf="!isEditing && shape.text"
      (dblclick)="$event.stopPropagation(); startEditing($event)"
      (mousedown)="onTextContainerMouseDown($event)"
      [style.left.px]="shape.textPosition?.x"
      [style.top.px]="shape.textPosition?.y"
      [style.position]="shape.textPosition ? 'absolute' : null"
        [style.border]="'2px solid ' + shapeColor"
    >
      <div class="shape-text">
        <div class="text-content">
          {{ shape.text }}
        </div>
        <i 
          *ngIf="isTextTruncated"
          class="bi bi-info-circle info-icon"
          (mousedown)="$event.stopPropagation()"
          (click)="$event.stopPropagation(); showFullText($event)"
          title="Show full text">
        </i>
      </div>
    </div>
    
    <!-- Tooltip -->
    <div class="tooltip" *ngIf="showTooltip" (click)="$event.stopPropagation()">
      {{ shape.text }}
    </div>
    
    <!-- Editing container -->
    <div class="editing-container" *ngIf="isEditing" [style.width.px]="inputWidth"
      [style.left.px]="shape.textPosition?.x"
      [style.top.px]="shape.textPosition?.y"
      [style.position]="shape.textPosition ? 'absolute' : null"
      (mousedown)="onEditContainerMouseDown($event)">
      <input 
        #textInput
        type="text" 
        class="shape-input" 
        [(ngModel)]="editingText"
        (blur)="saveText()"
        (keydown.enter)="saveText()"
        (keydown.escape)="cancelEditing()"
        (click)="$event.stopPropagation()"
        (mousedown)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()"
        placeholder="Enter text..."
        [style.width.px]="inputWidth"
        style="box-sizing: border-box;"
          [style.border]="'2px solid ' + shapeColor"
        autofocus>
    </div>
  </div>
</div>
